<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Socket.IO chat</title>
  </head>
  <body>
    <div id="login-zone">
        <form id="login-form">
            <input id="login-name" type="text" autocomplete="off">
            <input id="login-password" type="password">
            <button>Login</button>
            <p id="login-error-message" style="color: red;"></p>
        </form>
    </div>

    <div id="chat-zone" style="display: none;">
        <div id="chat-room">
            <ul id="messages"></ul>
            <form id="chat-form">
              <input id="chat-input" autocomplete="off" /><button>Send</button>
            </form>
        </div>
        <ul id="rooms-list"></ul>
        <button id="logout-btn">Logout</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script type="module" src="socket.js"></script>
    <script type="module" src="load.js"></script>
    <script type="module" src="render.js"></script>
    <script type="module" src="chat-on.js"></script>
    <script type="module" src="chat-off.js"></script>

    <script type="module">
        import { socket_config } from "./socket.js";
        import { load_admin, load_room, load_user, load_client_info } from "./load.js";
        import { render_messages } from "./render.js";

        const login_zone = document.getElementById("login-zone");
        const login_form = document.getElementById("login-form");
        const login_name = document.getElementById("login-name");
        const login_pw = document.getElementById("login-password");
        const login_err_msg = document.getElementById("login-error-message");

        const chat_zone = document.getElementById("chat-zone");
        const msgs = document.getElementById("messages");
        const chat_form = document.getElementById("chat-form");
        const chat_inp = document.getElementById("chat-input");
        const logout_btn = document.getElementById("logout-btn");
        const rms_lst = document.getElementById("rooms-list");

        const login_zone_elms = { login_zone, login_form, login_name, login_pw, login_err_msg }
        const chat_zone_elms = { chat_zone, msgs, chat_form, chat_inp , logout_btn, rms_lst }
        const client_elms = {
            ...login_zone_elms,
            ...chat_zone_elms
        }

        const client_info = {
            origin : "http://localhost:3000",
            admin : {},
            rooms_cache : [],
            loaded_user : [],
            users_cache : [],
            socket : {},
            current_room_id : ""
        };

        import { chat_on } from "./chat-on.js";
        login_form.addEventListener("submit", (e) => {
            e.preventDefault();
            if(login_name.value && login_pw.value) {
                const name = login_name.value;
                const pw = login_pw.value;

                const login_info = { name, pw };

                load_admin(login_info)
                    .then(data => {
                        console.log(data);
                        if(!data.error) {
                            admin = data;
                            load_client_info(client_info);
                            chat_on(client_info, client_elms);
                        } else {
                            login_err_msg.innerText = data.error;
                        }
                    })
            }
        })


        // chat_form.addEventListener("submit", (e) => {
        //     e.preventDefault();
        //     if(chat_inp.value) {
        //         const data = {
        //             message: chat_inp.value,
        //             room: current_room_id
        //         }
        //         socket.emit("chat message", data);
        //         chat_inp.value = "";
        //     }
        // });

        import { chat_off } from "./chat-off.js";  
        logout_btn.addEventListener("click", (e) => {
            e.preventDefault();
            chat_off(client_info, client_elms);
        });

    </script>
  </body>
</html>