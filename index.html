<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Socket.IO chat</title>
    <style>

    </style>
  </head>
  <body>
    <div id="login-zone">
        <form id="login-form">
            <input id="login-name" type="text" autocomplete="off">
            <button>Login</button>
            <p id="error-p" style="color: red;"></p>
        </form>
    </div>
    <div id="chat-zone" style="display: none;">
        <ul id="messages"></ul>
        <form id="form" action="">
          <input id="input" autocomplete="off" /><button>Send</button>
        </form>
    </div>

    <script>
        const getUserRooms = async (user_name) => {
            const responce = await fetch(`${origin}/room-in/${user_name}`)
            if(!responce.ok) {
                throw Error("responce not ok");
            }
            const rooms = await responce.json();
            return rooms;
        }

        const getRoomMessages = async (room_id) => {
            const responce = await fetch(`${origin}/room-messages/${room_id}`)
            if(!responce.ok) {
                throw Error("responce not ok");
            }
            const messages = await responce.json();
            return messages;
        }

        const login_form = document.getElementById("login-form");
        const login_name = document.getElementById("login-name");
        const login_zone = document.getElementById("login-zone");
        const chat_zone = document.getElementById("chat-zone");
        const error_p = document.getElementById("error-p");

        var user_name = "";
        var rooms_id = [];
        var origin = "http://localhost:3000";

        login_form.addEventListener("submit", (e) => {
            e.preventDefault();
            if(login_name) {
                getUserRooms(login_name.value)
                    .then((rooms) => {
                        if(!rooms.error) {
                            rooms_id = rooms;
                            user_name = login_name.value;
                            login_name.value = "";
                            console.log(rooms_id);
                            login_form.style.display = "none";
                            chat_zone.style.display = "block";
                            chatScript();
                        } else {
                            console.error(rooms);
                            error_p.innerText = rooms.error;
                            login_name.value = "";
                        }
                    })
            }
        })

    </script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        function chatScript() {
            const socket = io();

            const form = document.getElementById("form");
            const input = document.getElementById("input");
            const ul = document.getElementById("messages");

            // render room 1 messages
            getRoomMessages(rooms_id[0])
                .then((messages) => {
                    messages.forEach(message => {
                        const li = document.createElement("li");
                        if(message["sender-name"] == user_name) {
                            li.style.color = "green";
                        }
                        li.textContent = message.data;
                        ul.appendChild(li); 
                    });
                })

            socket.on("chat message", (message) => {
                const li = document.createElement("li");
                li.textContent = message;
                ul.appendChild(li);
            });

            socket.onAny((eName, ...args) => {
                console.log("Incomming", eName, args);
            })
            socket.onAnyOutgoing((eName, ...args) => {
                console.log("Outgoing:", eName, args);
            })

            form.addEventListener("submit", (e) => {
                e.preventDefault();
                if(input.value) {
                    socket.emit("chat message", input.value);
                    const li = document.createElement("li");
                    li.style.color = "green";
                    li.textContent = input.value;
                    input.value = "";
                    ul.appendChild(li);
                }
            });
        }
    </script>
  </body>
</html>